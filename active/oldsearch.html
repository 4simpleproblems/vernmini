<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>VERN MAX - BROWSER</title>
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="icon" type="image/x-icon" href="logo.png" id="app-favicon" />
    <style id="custom-styles">
        /* Core Theme Variables & Component Mappings */
        :root {
            --current-theme-bg: #23272A;
            --current-theme-text: #E0E1DD;
            --current-theme-accent: #7F5AF0;
            --current-theme-neutral: #2C2F33;
            --current-theme-button-text: #FFFFFF;
            --current-theme-shadow-rgb: 0, 0, 0;
            --current-theme-shadow-opacity-strong: 0.4;
            --current-theme-shadow-opacity-medium: 0.25;
            --current-theme-shadow-opacity-light: 0.15;
            --current-theme-focus-ring-color: var(--current-theme-accent);

            --bg-color: var(--current-theme-bg);
            --text-color: var(--current-theme-text);
            --iframe-bg: var(--current-theme-bg);
            --font-family-main: 'PrimaryFont', sans-serif;

            --toolbar-bg: var(--current-theme-neutral);
            --toolbar-shadow: 0 2px 5px rgba(var(--current-theme-shadow-rgb), var(--current-theme-shadow-opacity-medium));
            --toolbar-border-color: color-mix(in srgb, var(--current-theme-neutral) 70%, var(--current-theme-text));

            --button-bg: var(--current-theme-accent);
            --button-hover-bg: color-mix(in srgb, var(--current-theme-accent) 80%, var(--current-theme-text));
            --button-text-color: var(--current-theme-button-text);
            --button-outline-color: color-mix(in srgb, var(--current-theme-accent) 60%, transparent);

            --input-bg: color-mix(in srgb, var(--current-theme-neutral) 90%, var(--current-theme-bg));
            --input-focus-bg: var(--current-theme-bg);
            --input-focus-shadow: 0 0 0 2px color-mix(in srgb, var(--current-theme-focus-ring-color) 50%, transparent);

            --menu-bg: var(--input-bg);
            --menu-item-hover-bg: var(--button-hover-bg);
            --menu-text-color: var(--text-color);
            --menu-shadow: 0 4px 12px rgba(var(--current-theme-shadow-rgb), var(--current-theme-shadow-opacity-strong));
            --menu-border-color: var(--button-outline-color);
        }

        /* Base Styles */
        html, body {
            margin: 0; padding: 0; border: none; box-sizing: border-box;
            width: 100%; height: 100%; overflow: hidden;
            font-family: var(--font-family-main);
            background-color: var(--bg-color); color: var(--text-color);
            display: flex; flex-direction: column;
        }
        canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; display: none; pointer-events: none; }

        /* Toolbar */
        #toolbar {
            display: flex; align-items: center; padding: 8px 10px;
            background-color: var(--toolbar-bg); box-shadow: var(--toolbar-shadow);
            border-bottom: 1px solid var(--toolbar-border-color); z-index: 1000; position: relative;
        }
        .nav-button, .toolbar-button {
            width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
            margin-right: 8px; border-radius: 25%; background-color: var(--button-bg);
            cursor: pointer; color: var(--button-text-color); transition: background-color 0.2s, color 0.2s;
            box-shadow: 0 0 0 1px var(--button-outline-color); font-size: 20px;
            position: relative; flex-shrink: 0;
        }
        .nav-button:hover, .toolbar-button:hover { background-color: var(--button-hover-bg); }
        .nav-button .icon-img, .toolbar-button .icon-img {
            width: 20px; height: 20px; user-select: none; pointer-events: none;
        }
        #search-bar {
            flex: 1; height: 36px; border-radius: 8px; border: none; background-color: var(--input-bg);
            color: var(--text-color); padding: 0 15px; font-size: 14px;
            box-shadow: 0 0 0 1px var(--button-outline-color); font-family: var(--font-family-main);
            margin-right: 8px;
        }
        #search-bar:focus { outline: none; background-color: var(--input-focus-bg); box-shadow: var(--input-focus-shadow); }
        #settings-button { margin-right: 0; }

        /* Menus */
        .mini-menu {
            position: absolute; background-color: var(--menu-bg);
            border: 1px solid var(--menu-border-color); border-radius: 16px;
            box-shadow: var(--menu-shadow); z-index: 1005; min-width: 280px;
            max-width: 350px; max-height: 450px; overflow-y: auto; padding: 10px;
            color: var(--menu-text-color); opacity: 0; visibility: hidden;
            transform: translateY(-10px) scale(0.98);
            transition: opacity 0.25s ease-out, transform 0.25s ease-out, visibility 0s linear 0.25s;
        }
        .mini-menu.show {
            opacity: 1; visibility: visible; transform: translateY(0) scale(1);
            transition: opacity 0.25s ease-out, transform 0.25s ease-out, visibility 0s linear 0s;
        }
        .mini-menu h3 {
            margin-top: 0; margin-bottom: 10px; font-size: 1.1em;
            border-bottom: 1px solid var(--toolbar-border-color); padding-bottom: 8px;
            font-weight: 600; display: flex; align-items: center; gap: 8px;
        }
        .mini-menu h3 .icon-img { width: 1em; height: 1em; }
        .mini-menu ul { list-style: none; padding: 0; margin: 0; }
        .mini-menu::-webkit-scrollbar, .mini-menu ul::-webkit-scrollbar { width: 5px; }
        .mini-menu::-webkit-scrollbar-thumb, .mini-menu ul::-webkit-scrollbar-thumb { background-color: var(--button-outline-color); border-radius: 8px; }

        /* Menu Items & Controls */
        .mini-menu li {
            padding: 9px 15px; margin-bottom: 7px; border-radius: 12px;
            cursor: pointer; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            transition: background-color 0.2s ease, color 0.2s ease;
            background-color: color-mix(in srgb, var(--current-theme-neutral) 70%, var(--current-theme-bg));
            color: var(--text-color); position: relative;
        }
        .mini-menu li:hover { background-color: var(--menu-item-hover-bg); color: var(--button-text-color); }
        .mini-menu li .item-url { font-size: 0.75em; opacity: 0.7; display: block; margin-top: 2px; }
        .mini-menu .item-remove-button {
            position:absolute; right:12px; top:50%; transform:translateY(-50%); cursor:pointer; padding: 5px;
            opacity: 0.7; display:inline-flex; align-items:center; justify-content:center;
            background: none; border: none; color: inherit;
        }
        .mini-menu .item-remove-button:hover { opacity: 1; background-color: rgba(var(--current-theme-shadow-rgb),0.1); border-radius: 50%; }
        .mini-menu .item-remove-icon { width: 12px; height: 12px; display: block; }

        /* History Menu Specifics */
        .history-group-header {
            font-size: 0.8em; font-weight: bold; color: var(--text-color);
            opacity: 0.7; padding: 10px 15px 5px; text-transform: uppercase;
        }

        /* Menu Controls */
        .mini-menu .menu-action-bar { margin-top:15px; padding-top:10px; border-top: 1px solid var(--toolbar-border-color); }
        .mini-menu .menu-input, .mini-menu .menu-select {
            width: 100%; height: 38px; padding: 0 15px; margin-bottom: 10px;
            background-color: var(--input-bg); color: var(--text-color);
            border: none; border-radius: 12px; font-family: var(--font-family-main);
            box-sizing: border-box; box-shadow: 0 0 0 1px var(--button-outline-color); font-size: 0.9em;
        }
        .mini-menu .menu-input:focus, .mini-menu .menu-select:focus { outline: none; background-color: var(--input-focus-bg); box-shadow: var(--input-focus-shadow); }
        .mini-menu .menu-button {
            width: 100%; height: 38px; padding: 0 15px; background-color: var(--button-bg);
            color: var(--button-text-color); border: none; border-radius: 12px; cursor: pointer;
            transition: background-color 0.2s ease; font-family: var(--font-family-main);
            box-shadow: 0 0 0 1px var(--button-outline-color); display: flex;
            align-items: center; justify-content: center; font-size: 0.9em; font-weight: 500;
        }
        .mini-menu .menu-button:hover { background-color: var(--button-hover-bg); }
        .mini-menu .menu-button .icon-img { width: 16px; height: 16px; margin-right: 8px; }
        .mini-menu .menu-button.clear-button { background-color: color-mix(in srgb, var(--current-theme-accent) 60%, #c0392b); }
        .mini-menu .menu-button.clear-button:hover { background-color: #c0392b; }

        /* Settings Menu */
        .menu-setting-item { display: flex; flex-direction: column; gap: 6px; margin-bottom: 12px; }
        .menu-setting-item label { font-size: 0.85em; opacity: 0.8; padding-left: 5px; }

        /* Conditional Custom Cloak Section */
        #custom-cloak-settings-container {
            opacity: 0; max-height: 0; overflow: hidden;
            transition: opacity 0.3s ease-in-out, max-height 0.3s ease-in-out;
            margin-top: 0; padding-top: 0;
        }
        #custom-cloak-settings-container.visible {
            opacity: 1; max-height: 300px; 
            margin-top: 15px; padding-top: 10px;
            border-top: 1px solid var(--toolbar-border-color);
        }

        /* Main Content */
        #content-container { flex: 1; position: relative; background-color: var(--iframe-bg); overflow: hidden; }
        #content-iframe { width: 100%; height: 100%; border: none; display: block; }
        
        /* Animations & States */
        #refresh-button .icon-img.spinning { animation: spinRefreshIcon 0.7s linear infinite; }
        @keyframes spinRefreshIcon { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        body.app-ui-hidden #toolbar { display: none !important; }

        /* --- Special Theme Features --- */
        /* Bottom Bar Theme */
        body.theme-bottom-bar { flex-direction: column-reverse; }
        body.theme-bottom-bar #toolbar { border-top: 1px solid var(--toolbar-border-color); border-bottom: none; }
        body.theme-bottom-bar .mini-menu { transform-origin: bottom right; }

        /* Floating Toolbar Theme */
        body.theme-floating-toolbar #toolbar {
            margin: 10px; border-radius: 12px; width: calc(100% - 20px);
            background-color: color-mix(in srgb, var(--toolbar-bg) 85%, transparent);
            backdrop-filter: blur(5px);
        }

        /* Retro Terminal Theme */
        body.theme-retro-terminal #search-bar:focus { animation: blink-caret 1s step-end infinite; }
        @keyframes blink-caret {
            from, to { box-shadow: var(--input-focus-shadow), inset 2px 0 0 0 var(--current-theme-accent); }
            50% { box-shadow: var(--input-focus-shadow), inset 2px 0 0 0 transparent; }
        }

        /* Minimalist Theme */
        body.theme-minimalist .toolbar-button, body.theme-minimalist #fullscreen-button {
            opacity: 0; transform: scale(0.8); transition: opacity 0.3s, transform 0.3s;
        }
        body.theme-minimalist #toolbar:hover .toolbar-button, body.theme-minimalist #toolbar:hover #fullscreen-button {
            opacity: 1; transform: scale(1);
        }

        /* Glitchy Theme */
        body.theme-glitchy { animation: glitch-anim 7s infinite steps(8) alternate; }
        @keyframes glitch-anim {
            0% { transform: translate(0); } 10% { transform: translate(-2px, 2px); } 20% { transform: translate(2px, -2px); }
            30% { transform: translate(-2px, -2px); } 40% { transform: translate(2px, 2px); } 50% { transform: translate(0); }
            100% { transform: translate(0); }
        }

        /* Flipped Mode Theme */
        body.theme-flipped-mode #toolbar, body.theme-flipped-mode #content-container { transform: scaleX(-1); }
        body.theme-flipped-mode .nav-button, body.theme-flipped-mode .toolbar-button, body.theme-flipped-mode #search-bar, body.theme-flipped-mode .mini-menu {
            transform: scaleX(-1);
        }

        /* Translucent UI Theme */
        body.theme-translucent-ui #toolbar {
            background-color: color-mix(in srgb, var(--toolbar-bg) 60%, transparent);
            border-bottom-color: color-mix(in srgb, var(--toolbar-border-color) 60%, transparent);
            box-shadow: none;
            backdrop-filter: blur(8px);
        }
        body.theme-translucent-ui .nav-button,
        body.theme-translucent-ui .toolbar-button {
             background-color: color-mix(in srgb, var(--button-bg) 60%, transparent);
        }
        body.theme-translucent-ui .mini-menu {
             background-color: color-mix(in srgb, var(--menu-bg) 60%, transparent);
             backdrop-filter: blur(8px);
        }

        /* Homepage Styles */
        #homepage {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            text-align: center;
            background-color: var(--bg-color);
        }

        #homepage-logo {
            width: 272px;
            height: 92px;
            margin-bottom: 28px;
        }

        #homepage-search-container {
            position: relative;
            width: 584px;
            max-width: 90%;
            display: flex;
            align-items: center;
            border-radius: 24px;
            background-color: var(--input-bg);
            border: 1px solid var(--button-outline-color);
        }

        #homepage-search-container:focus-within {
             box-shadow: var(--input-focus-shadow);
        }

        #homepage-search-icon {
            width: 20px;
            height: 20px;
            margin: 0 15px;
            opacity: 0.7;
        }

        #homepage-search-bar {
            width: 100%;
            height: 44px;
            border: none;
            background: transparent;
            color: var(--text-color);
            padding: 0;
            font-size: 16px;
            box-sizing: border-box;
            outline: none;
        }

        #homepage-buttons {
            margin-top: 18px;
        }

        #homepage-search-button {
            background-color: var(--button-bg);
            color: var(--button-text-color);
            border: none;
            border-radius: 4px;
            font-size: 14px;
            margin: 11px 4px;
            padding: 0 16px;
            line-height: 36px;
            height: 36px;
            min-width: 54px;
            text-align: center;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s ease;
        }

        #homepage-search-button:hover {
             background-color: var(--button-hover-bg);
        }

        #search-suggestions {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: var(--menu-bg);
            border: 1px solid var(--menu-border-color);
            border-top: none;
            border-radius: 0 0 24px 24px;
            list-style: none;
            padding: 10px 0;
            margin: 0;
            text-align: left;
            z-index: 100;
        }

        #search-suggestions li {
            padding: 10px 20px;
            cursor: pointer;
            color: var(--menu-text-color);
        }

        #search-suggestions li:hover {
            background-color: var(--menu-item-hover-bg);
             color: var(--button-text-color);
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>

    <template id="bookmark-item-template">
        <li>
            <span class="item-name"></span><span class="item-url"></span>
            <button class="item-remove-button" title="Remove Bookmark"><img src="../images/cross-white.png" alt="Remove" class="item-remove-icon"></button>
        </li>
    </template>
    <template id="history-item-template">
        <li><span class="item-name"></span><span class="item-url"></span></li>
    </template>
    <template id="history-group-template">
        <div class="history-group-header"></div>
    </template>

    <div id="toolbar">
        <div class="nav-button" id="home-button" title="Home"><img src="../images/home-white.png" alt="Home" class="icon-img"></div>
        <div class="nav-button" id="back-button" title="Back"><img src="../images/arrow-left-white.png" alt="Back" class="icon-img"></div>
        <div class="nav-button" id="forward-button" title="Forward"><img src="../images/arrow-right-white.png" alt="Forward" class="icon-img"></div>
        <div class="nav-button" id="refresh-button" title="Refresh"><img src="../images/refresh-white.png" alt="Refresh" class="icon-img"></div>
        <input type="text" id="search-bar" placeholder="Search or type a URL">
        
        <div class="toolbar-button" id="fullscreen-button" title="Toggle Fullscreen"><img src="../images/zoom-in-white.png" alt="Toggle Fullscreen" id="fullscreen-icon-img" class="icon-img"></div>
        <div class="toolbar-button" id="bookmark-button" title="Bookmarks"><img src="../images/star-white.png" alt="Bookmarks" class="icon-img"></div>
        <div class="toolbar-button" id="history-button" title="History"><img src="../images/clock-white.png" alt="History" class="icon-img"></div>
        <div class="toolbar-button" id="settings-button" title="Settings"><img src="../images/gear-white.png" alt="Settings" class="icon-img"></div>
    </div>

    <div id="bookmark-menu" class="mini-menu">
        <h3><img src="../images/star-white.png" alt="Bookmarks" class="icon-img"> Bookmarks</h3>
        <ul id="bookmarks-list-popup"></ul>
        <div class="menu-action-bar">
            <input type="text" id="new-bookmark-name-popup" class="menu-input" placeholder="Bookmark Name (optional)">
            <button id="add-current-bookmark-button-popup" class="menu-button"><img src="../images/plus-symbol-white.png" alt="Add" class="icon-img">Bookmark Current Page</button>
        </div>
    </div>
    
    <div id="history-menu" class="mini-menu">
        <h3><img src="../images/clock-white.png" alt="History" class="icon-img"> History</h3>
        <input type="text" id="history-search-bar" class="menu-input" placeholder="Search history">
        <ul id="history-list-popup"></ul>
    </div>

    <div id="settings-menu" class="mini-menu">
        <h3><img src="../images/gear-white.png" alt="Settings" class="icon-img"> Settings</h3>
        <div class="menu-setting-item">
            <label for="theme-selector">Theme</label>
            <select id="theme-selector" class="menu-select"></select>
        </div>
        <div class="menu-setting-item">
            <label for="search-engine-selector">Search Engine</label>
            <select id="search-engine-selector" class="menu-select"></select>
        </div>
         <div class="menu-setting-item">
            <label for="history-lifespan-selector">Clear History After</label>
            <select id="history-lifespan-selector" class="menu-select">
                <option value="0">Never</option>
                <option value="1">1 Day</option>
                <option value="3">3 Days</option>
                <option value="7">7 Days</option>
                <option value="14">14 Days</option>
            </select>
        </div>
        <div class="menu-setting-item">
            <label for="cloak-preset-selector">Tab Cloak Preset</label>
            <select id="cloak-preset-selector" class="menu-select"></select>
        </div>
        
        <div id="custom-cloak-settings-container">
            <h3><img src="../images/plus-symbol-white.png" alt="Custom Cloak" class="icon-img"> Custom Cloak</h3>
            <div class="menu-setting-item">
                <label for="custom-cloak-title">Custom Title</label>
                <input type="text" id="custom-cloak-title" class="menu-input" placeholder="e.g., Google Docs">
            </div>
            <div class="menu-setting-item">
                <label for="custom-cloak-url">Favicon URL</label>
                <input type="text" id="custom-cloak-url" class="menu-input" placeholder="e.g., https://google.com">
            </div>
            <button id="apply-custom-cloak-button" class="menu-button">Apply Custom Cloak</button>
        </div>

        <div class="menu-action-bar"></div>
        <button id="clear-browser-data-button" class="menu-button clear-button">Clear All Browser Data</button>
    </div>

    <div id="content-container">
        <div id="homepage">
            <img id="homepage-logo" src="../images/title.png" alt="VERN MAX">
            <div id="homepage-search-container">
                <img id="homepage-search-icon" src="../images/magnify-white.png" alt="Search">
                <input type="text" id="homepage-search-bar" placeholder="Search or type a URL">
                <ul id="search-suggestions"></ul>
            </div>
            <div id="homepage-buttons">
                <button id="homepage-search-button">Search</button>
            </div>
        </div>
        <iframe id="content-iframe" title="Content View" sandbox="allow-forms allow-modals allow-pointer-lock allow-popups allow-presentation allow-same-origin allow-scripts allow-downloads allow-popups-to-escape-sandbox"></iframe>
    </div>

    <script src="uv/uv.bundle.js" defer></script>
    <script src="uv/uv.config.js" defer></script>
    <script src="register-sw.js" defer></script>
    <script>
        // --- CONTEXT & STATE VARIABLES ---
        let currentUrl = 'about:blank';
        let currentTitle = 'New Tab';
        let isLoading = false;
        let isRefreshing = false;
        
        const searchEngines = {
            'google': { name: 'Google', url: 'https://www.google.com/search?q=%s' },
            'duckduckgo': { name: 'DuckDuckGo', url: 'https://duckduckgo.com/?q=%s' },
            'bing': { name: 'Bing', url: 'https://www.bing.com/search?q=%s' },
            'brave': { name: 'Brave Search', url: 'https://search.brave.com/search?q=%s' }
        };
        let currentSearchEngineKey = 'google';

        const cloakPresets = {
            'none': { displayName: "None (Real Title/Favicon)" },
            'custom': { displayName: "Custom (Manual)" },
            'google_docs': { displayName: "Google Docs", title: 'Google Docs', faviconUrl: 'https://ssl.gstatic.com/docs/documents/images/kix-favicon7.ico' },
            'google_slides': { displayName: "Google Slides", title: 'Google Slides', faviconUrl: 'https://ssl.gstatic.com/docs/presentations/images/favicon5.ico' },
            'google_classroom': { displayName: "Google Classroom", title: 'Home', faviconUrl: 'https://ssl.gstatic.com/classroom/favicon.png' },
            'gmail': { displayName: "Gmail", title: 'Inbox', faviconUrl: 'https://ssl.gstatic.com/ui/v1/icons/mail/rfr/gmail.ico' },
            'clever': { displayName: "Clever", title: 'Clever | Portal', faviconUrl: 'https://assets.clever.com/launchpad/1a74895/favicon.ico?1' },
            'hac': { displayName: "Home Access Center", title: 'Home Access Center', faviconUrl: 'https://hac.doe.k12.de.us/HomeAccess/Content/Images/favicon.ico' },
            'google_drive': { displayName: "My Drive", title: 'My Drive - Google Drive', faviconUrl: 'https://ssl.gstatic.com/images/branding/product/1x/drive_2020q4_32dp.png' },
            'wikipedia': { displayName: "Wikipedia", title: 'Wikipedia', faviconUrl: 'https://en.wikipedia.org/static/favicon/wikipedia.ico' },
        };
        let currentCloakPresetKey = 'none';

        const THEMES = {
            main: { name: "Main (Default)", colors: { bg: '#23272A', text: '#E0E1DD', accent: '#7F5AF0', neutral: '#2C2F33', btnText: '#FFFFFF' } }, 
            light: { name: "Light", colors: { bg: '#F5F7FA', text: '#333333', accent: '#3498DB', neutral: '#FFFFFF', btnText: '#FFFFFF' } }, 
            dark: { name: "Dark", colors: { bg: '#1E1E1E', text: '#F1F1F1', accent: '#BB86FC', neutral: '#2A2A2A', btnText: '#000000' } }, 
            oceanic: { name: "Oceanic", colors: { bg: '#0A2E36', text: '#E0F4F2', accent: '#2E8B57', neutral: '#144552', btnText: '#FFFFFF' } }, 
            sunset: { name: "Sunset", colors: { bg: '#2C3E50', text: '#FAD7A0', accent: '#E74C3C', neutral: '#34495E', btnText: '#FFFFFF' } }, 
            forest: { name: "Forest", colors: { bg: '#2d3a32', text: '#e6e2dd', accent: '#588157', neutral: '#344e41', btnText: '#FFFFFF' } }, 
            rose: { name: "RosÃ© Quartz", colors: { bg: '#f7d1cd', text: '#5e3d42', accent: '#e8959e', neutral: '#f2b5b0', btnText: '#5e3d42' } }, 
            coffee: { name: "Coffee House", colors: { bg: '#4a403a', text: '#e7e2dd', accent: '#a5a58d', neutral: '#6b5f58', btnText: '#FFFFFF' } }, 
            matrix: { name: "Matrix", colors: { bg: '#000000', text: '#00FF41', accent: '#00A329', neutral: '#050505', btnText: '#000000' } }, 
            cyberpunk: { name: "Cyberpunk", colors: { bg: '#0d0221', text: '#f0f0f0', accent: '#f72585', neutral: '#261a3b', btnText: '#FFFFFF' } }, 
            dracula: { name: "Dracula", colors: { bg: '#282a36', text: '#f8f8f2', accent: '#bd93f9', neutral: '#44475a', btnText: '#f8f8f2' } }, 
            nord: { name: "Nord", colors: { bg: '#2E3440', text: '#D8DEE9', accent: '#88C0D0', neutral: '#3B4252', btnText: '#2E3440' } }, 
            gruvbox: { name: "Gruvbox", colors: { bg: '#282828', text: '#ebdbb2', accent: '#fabd2f', neutral: '#3c3836', btnText: '#282828' } }, 
            tokyo: { name: "Tokyo Night", colors: { bg: '#1a1b26', text: '#a9b1d6', accent: '#7aa2f7', neutral: '#292e42', btnText: '#FFFFFF' } }, 
            
            // SPECIAL THEMES
            bottom_bar: { name: "Bottom Bar", feature: 'bottomBar', colors: { bg: '#23272A', text: '#E0E1DD', accent: '#7F5AF0', neutral: '#2C2F33', btnText: '#FFFFFF' } },
            particle_flow: { name: "Particle Flow", feature: 'particleFlow', colors: { bg: '#0d0221', text: '#f0f0f0', accent: '#f72585', neutral: '#261a3b', btnText: '#FFFFFF' } },
            retro_terminal: { name: "Retro Terminal", feature: 'retroTerminal', colors: { bg: '#000000', text: '#00FF41', accent: '#00A329', neutral: '#050505', btnText: '#000000' } },
            floating_toolbar: { name: "Floating Toolbar", feature: 'floatingToolbar', colors: { bg: '#2E3440', text: '#D8DEE9', accent: '#88C0D0', neutral: '#3B4252', btnText: '#2E3440' } },
            minimalist: { name: "Minimalist", feature: 'minimalist', colors: { bg: '#F5F7FA', text: '#333333', accent: '#3498DB', neutral: '#FFFFFF', btnText: '#FFFFFF' } },
            ocean_deep: { name: "Ocean Deep", feature: 'oceanDeep', colors: { bg: '#0A2E36', text: '#E0F4F2', accent: '#2E8B57', neutral: '#144552', btnText: '#FFFFFF' } },
            sakura_blossom: { name: "Sakura Blossom", feature: 'sakuraBlossom', colors: { bg: '#fff0f3', text: '#5e3d42', accent: '#e8959e', neutral: '#ffe0e7', btnText: '#5e3d42' } },
            glitchy: { name: "Glitchy", feature: 'glitchy', colors: { bg: '#0d1117', text: '#c9d1d9', accent: '#58a6ff', neutral: '#161b22', btnText: '#ffffff' } },
            flipped_mode: { name: "Flipped Mode", feature: 'flippedMode', colors: { bg: '#282828', text: '#ebdbb2', accent: '#fabd2f', neutral: '#3c3836', btnText: '#282828' } },
            translucent_ui: { name: "Translucent UI", feature: 'translucentUi', colors: { bg: '#212121', text: '#ffffff', accent: '#82aaff', neutral: '#292929', btnText: '#ffffff' } }
        };

        // --- DOM ELEMENT REFERENCES ---
        let contentIframeEl, searchBarEl, homeButtonEl, backButtonEl, forwardButtonEl, refreshButtonEl,
            fullscreenButtonEl, settingsButtonEl, bookmarkButtonEl, historyButtonEl, bookmarkMenuEl, 
            historyMenuEl, settingsMenuEl, bookmarksListPopupEl, newBookmarkNameInputPopupEl, 
            addCurrentBookmarkButtonPopupEl, historyListPopupEl, toolbarEl, 
            themeSelectorEl, cloakPresetSelectorEl, customCloakTitleEl, customCloakUrlEl, applyCustomCloakButtonEl,
            searchEngineSelectorEl, historyLifespanSelectorEl, clearBrowserDataButtonEl, historySearchBarEl,
            customCloakSettingsContainerEl, homepageEl, homepageSearchBarEl, searchSuggestionsEl,
            homepageSearchButtonEl;

        let bookmarkItemTemplate, historyItemTemplate, historyGroupTemplate;
        
        // --- PARTICLE ENGINE ---
        let particleAnimationId = null;
        const canvasEl = document.getElementById('canvas');
        const canvasCtx = canvasEl.getContext('2d');
        let particles = [];

        function resizeCanvas() { canvasEl.width = window.innerWidth; canvasEl.height = window.innerHeight; }
        function stopAllParticles() { if (particleAnimationId) { cancelAnimationFrame(particleAnimationId); particleAnimationId = null; } particles = []; canvasCtx.clearRect(0, 0, canvasEl.width, canvasEl.height); canvasEl.style.display = 'none'; }
        function startParticleEffect(type) {
            stopAllParticles();
            canvasEl.style.display = 'block';
            resizeCanvas();
            let config = {};
            switch(type) {
                case 'particleFlow': config = { count: 150, shape: 'line', speed: 1, maxSize: 4, color: 'rgba(247, 37, 133, 0.7)' }; break;
                case 'oceanDeep': config = { count: 100, shape: 'circle', speed: 0.5, maxSize: 8, color: 'rgba(224, 244, 242, 0.5)', vertical: true }; break;
                case 'sakuraBlossom': config = { count: 30, shape: 'text', text: 'ðŸŒ¸', speed: 1, maxSize: 25, color: '#FFB7C5' }; break;
                default: return;
            }
            for (let i = 0; i < config.count; i++) { particles.push({ x: Math.random() * canvasEl.width, y: config.vertical ? canvasEl.height + Math.random() * 100 : Math.random() * canvasEl.height, size: Math.random() * config.maxSize + 1, speedX: (Math.random() * 2 - 1) * config.speed, speedY: config.vertical ? (Math.random() * -1 - 0.5) * config.speed : (Math.random() * 2 - 1) * config.speed, ...config }); }
            animateParticles();
        }
        function animateParticles() {
            canvasCtx.clearRect(0, 0, canvasEl.width, canvasEl.height);
            for (let i = 0; i < particles.length; i++) {
                let p = particles[i]; p.x += p.speedX; p.y += p.speedY;
                if (p.x > canvasEl.width + p.size) p.x = -p.size; else if (p.x < -p.size) p.x = canvasEl.width + p.size;
                if (p.y < -p.size) p.y = p.vertical ? canvasEl.height + p.size : canvasEl.height + p.size; else if (p.y > canvasEl.height + p.size && !p.vertical) p.y = -p.size;
                canvasCtx.fillStyle = p.color; canvasCtx.strokeStyle = p.color;
                if (p.shape === 'circle') { canvasCtx.beginPath(); canvasCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2); canvasCtx.fill(); } 
                else if (p.shape === 'line') { canvasCtx.lineWidth = p.size / 2; canvasCtx.beginPath(); canvasCtx.moveTo(p.x, p.y); canvasCtx.lineTo(p.x + p.speedX * 5, p.y + p.speedY * 5); canvasCtx.stroke(); } 
                else if (p.shape === 'text') { canvasCtx.font = p.size + 'px sans-serif'; canvasCtx.fillText(p.text, p.x, p.y); }
            }
            particleAnimationId = requestAnimationFrame(animateParticles);
        }

        // --- CORE LOGIC ---
        document.addEventListener('DOMContentLoaded', async () => {
            assignDOMElements();
            populateThemeSelector();
            populateCloakSelector();
            populateSearchEngineSelector();
            await initUV();
            loadSettings();
            setupEventListeners();
            pruneHistory();
            loadBookmarks();
            loadHistory();
            const lastUrl = localStorage.getItem('vernLastUrl') || 'about:blank';
            navigateTo(lastUrl);
        });

        function assignDOMElements() {
            toolbarEl = document.getElementById('toolbar'); contentIframeEl = document.getElementById('content-iframe'); searchBarEl = document.getElementById('search-bar'); homeButtonEl = document.getElementById('home-button'); backButtonEl = document.getElementById('back-button'); forwardButtonEl = document.getElementById('forward-button'); refreshButtonEl = document.getElementById('refresh-button'); fullscreenButtonEl = document.getElementById('fullscreen-button'); settingsButtonEl = document.getElementById('settings-button'); bookmarkButtonEl = document.getElementById('bookmark-button'); historyButtonEl = document.getElementById('history-button');
            bookmarkMenuEl = document.getElementById('bookmark-menu'); historyMenuEl = document.getElementById('history-menu'); settingsMenuEl = document.getElementById('settings-menu');
            bookmarksListPopupEl = document.getElementById('bookmarks-list-popup'); newBookmarkNameInputPopupEl = document.getElementById('new-bookmark-name-popup'); addCurrentBookmarkButtonPopupEl = document.getElementById('add-current-bookmark-button-popup');
            historyListPopupEl = document.getElementById('history-list-popup'); historySearchBarEl = document.getElementById('history-search-bar');
            themeSelectorEl = document.getElementById('theme-selector'); searchEngineSelectorEl = document.getElementById('search-engine-selector'); historyLifespanSelectorEl = document.getElementById('history-lifespan-selector'); cloakPresetSelectorEl = document.getElementById('cloak-preset-selector');
            customCloakSettingsContainerEl = document.getElementById('custom-cloak-settings-container'); customCloakTitleEl = document.getElementById('custom-cloak-title'); customCloakUrlEl = document.getElementById('custom-cloak-url'); applyCustomCloakButtonEl = document.getElementById('apply-custom-cloak-button');
            clearBrowserDataButtonEl = document.getElementById('clear-browser-data-button');
            bookmarkItemTemplate = document.getElementById('bookmark-item-template');
            historyItemTemplate = document.getElementById('history-item-template');
            historyGroupTemplate = document.getElementById('history-group-template');
            homepageEl = document.getElementById('homepage'); homepageSearchBarEl = document.getElementById('homepage-search-bar'); searchSuggestionsEl = document.getElementById('search-suggestions');
            homepageSearchButtonEl = document.getElementById('homepage-search-button');
        }
        
        async function initUV() { try { await registerSW(); } catch (err) { console.error("SW registration failed:", err); }}

        function loadSettings() {
            const savedTheme = localStorage.getItem('vernTheme') || 'main';
            applyTheme(savedTheme);
            themeSelectorEl.value = savedTheme;

            currentSearchEngineKey = localStorage.getItem('vernSearchEngine') || 'google';
            searchEngineSelectorEl.value = currentSearchEngineKey;

            historyLifespanSelectorEl.value = localStorage.getItem('vernHistoryLifespan') || '14';
            
            currentCloakPresetKey = localStorage.getItem('vernCloakPreset') || 'none';
            cloakPresetSelectorEl.value = currentCloakPresetKey;
            customCloakTitleEl.value = localStorage.getItem('vernCustomCloakTitle') || '';
            customCloakUrlEl.value = localStorage.getItem('vernCustomCloakUrl') || '';
            applyBrowserCloak();
            toggleCustomCloakView(currentCloakPresetKey === 'custom');
        }

        function setupEventListeners() {
            fullscreenButtonEl.addEventListener('click', toggleIframeFullscreen); document.addEventListener('fullscreenchange', handleFullscreenChange);
            searchBarEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') navigateTo(e.target.value); });
            homeButtonEl.addEventListener('click', () => navigateTo('about:blank')); backButtonEl.addEventListener('click', () => contentIframeEl.contentWindow.history.back()); forwardButtonEl.addEventListener('click', () => contentIframeEl.contentWindow.history.forward());
            refreshButtonEl.addEventListener('click', () => { if (contentIframeEl.src !== 'about:blank') { const icon = refreshButtonEl.querySelector('.icon-img'); icon.classList.add('spinning'); isRefreshing = true; contentIframeEl.contentWindow.location.reload(true); } });
            contentIframeEl.addEventListener('load', handleIframeLoad);
            
            settingsButtonEl.addEventListener('click', (e) => { e.stopPropagation(); toggleSettingsMenu(); });
            bookmarkButtonEl.addEventListener('click', (e) => { e.stopPropagation(); toggleBookmarkMenu(); });
            historyButtonEl.addEventListener('click', (e) => { e.stopPropagation(); toggleHistoryMenu(); });
            document.addEventListener('click', closeAllMenus);
            
            addCurrentBookmarkButtonPopupEl.addEventListener('click', handleAddCurrentBookmark);
            bookmarksListPopupEl.addEventListener('click', handleBookmarkClick);
            historyListPopupEl.addEventListener('click', handleHistoryClick);
            historySearchBarEl.addEventListener('input', () => loadHistory(historySearchBarEl.value));

            themeSelectorEl.addEventListener('change', (e) => { applyTheme(e.target.value); localStorage.setItem('vernTheme', e.target.value); });
            searchEngineSelectorEl.addEventListener('change', (e) => { currentSearchEngineKey = e.target.value; localStorage.setItem('vernSearchEngine', e.target.value); });
            historyLifespanSelectorEl.addEventListener('change', (e) => { localStorage.setItem('vernHistoryLifespan', e.target.value); pruneHistory(); loadHistory(); });
            cloakPresetSelectorEl.addEventListener('change', (e) => {
                currentCloakPresetKey = e.target.value;
                localStorage.setItem('vernCloakPreset', currentCloakPresetKey);
                applyBrowserCloak();
                toggleCustomCloakView(currentCloakPresetKey === 'custom');
            });
            applyCustomCloakButtonEl.addEventListener('click', applyAndSaveCustomCloak);
            clearBrowserDataButtonEl.addEventListener('click', clearAllData);

            homepageSearchBarEl.addEventListener('input', handleSearchInput);
            homepageSearchBarEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') navigateTo(e.target.value); });
            homepageSearchButtonEl.addEventListener('click', () => navigateTo(homepageSearchBarEl.value));
            searchSuggestionsEl.addEventListener('click', (e) => {
                if (e.target.tagName === 'LI') {
                    navigateTo(e.target.textContent);
                }
            });

            document.addEventListener('keydown', handleGlobalKeyDown);
            window.addEventListener('resize', () => {
                resizeCanvas();
                if (document.querySelector('.mini-menu.show')) closeAllMenus(new MouseEvent('click'));
            });
        }

        // --- NAVIGATION & PROXY ---
        function navigateTo(urlInput) {
            isLoading = true;
            let targetUrl = 'about:blank';
            const trimmedInput = urlInput ? urlInput.trim() : '';
            if (trimmedInput !== '' && trimmedInput !== 'about:blank') {
                const formatted = formatUrlInput(trimmedInput);
                targetUrl = formatted ? formatted : searchEngines[currentSearchEngineKey].url.replace('%s', encodeURIComponent(trimmedInput));
            }
            if (targetUrl === 'about:blank') {
                showHomepage();
            } else {
                hideHomepage();
                contentIframeEl.src = proxyUrl(targetUrl);
            }
        }

        function handleIframeLoad() {
            isLoading = false;
            if (isRefreshing) { const icon = refreshButtonEl.querySelector('.icon-img'); icon.classList.remove('spinning'); isRefreshing = false; }
            let finalUrl = 'about:blank', finalTitle = 'New Tab';
            try {
                if (contentIframeEl.contentWindow && contentIframeEl.contentWindow.__uv && contentIframeEl.contentWindow.__uv.location.href !== 'about:blank') {
                    finalUrl = contentIframeEl.contentWindow.__uv.location.href;
                    finalTitle = contentIframeEl.contentDocument.title || new URL(finalUrl).hostname;
                }
            } catch (e) { /* silent fail */ }
            currentUrl = finalUrl;
            currentTitle = finalTitle;
            localStorage.setItem('vernLastUrl', currentUrl);
            searchBarEl.value = (currentUrl !== 'about:blank') ? currentUrl : '';
            applyBrowserCloak();
            if (currentUrl && !currentUrl.startsWith('about:')) addToHistory(currentTitle, currentUrl);

            if (currentUrl === 'about:blank') {
                showHomepage();
            } else {
                hideHomepage();
            }
        }

        function proxyUrl(urlToProxy) {
            if (!urlToProxy || typeof urlToProxy !== 'string' || urlToProxy.trim() === '') return null;
            if (urlToProxy.startsWith('data:')) return urlToProxy;
            if (typeof __uv$config === 'undefined') { return urlToProxy; }
            try { return self.location.origin + __uv$config.prefix + __uv$config.encodeUrl(urlToProxy); } 
            catch (e) { return urlToProxy; }
        }
        
        function formatUrlInput(input) { const trimmed = input.trim(); if (/^(?:[a-z]+:)?\/\//i.test(trimmed)) return trimmed; if (/^([a-zA-Z0-9-]+\.)+[a-zA-Z]{2,}(\/.*)*$/.test(trimmed)) return 'https://' + trimmed; return null; }

        // --- HOMEPAGE & SEARCH SUGGESTIONS ---
        function showHomepage() {
            homepageEl.style.display = 'flex';
            contentIframeEl.style.display = 'none';
        }

        function hideHomepage() {
            homepageEl.style.display = 'none';
            contentIframeEl.style.display = 'block';
        }

        function handleSearchInput() {
            const query = homepageSearchBarEl.value;
            if (query.length > 0) {
                fetch(`https://www.google.com/complete/search?client=firefox&q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        const suggestions = data[1];
                        searchSuggestionsEl.innerHTML = '';
                        suggestions.forEach(suggestion => {
                            const li = document.createElement('li');
                            li.textContent = suggestion;
                            searchSuggestionsEl.appendChild(li);
                        });
                        searchSuggestionsEl.style.display = 'block';
                    });
            } else {
                searchSuggestionsEl.style.display = 'none';
            }
        }


        // --- HISTORY & BOOKMARK MANAGEMENT ---
        function getHistory() { return JSON.parse(localStorage.getItem('vernHistory') || '[]'); }
        function saveHistory(history) { localStorage.setItem('vernHistory', JSON.stringify(history)); }
        function addToHistory(title, url) {
            if (localStorage.getItem('vernHistoryLifespan') === '0') return;
            let history = getHistory();
            if (history.length > 0 && history[history.length - 1].url === url) return;
            history.push({ title: title || url, url, timestamp: new Date().toISOString() });
            saveHistory(history);
            loadHistory(historySearchBarEl.value);
        }
        function loadHistory(searchTerm = '') {
            const filtered = getHistory().filter(item => searchTerm ? ((item.title && item.title.toLowerCase().includes(searchTerm.toLowerCase())) || (item.url && item.url.toLowerCase().includes(searchTerm.toLowerCase()))) : true);
            renderHistory(filtered);
        }
        function renderHistory(history) {
            const fragment = document.createDocumentFragment();
            if (history.length === 0) { const li = document.createElement('li'); li.textContent = 'No history found.'; li.style.cssText = 'cursor: default; text-align: center; opacity: 0.7;'; fragment.appendChild(li); } 
            else { const grouped = {}; [...history].reverse().forEach(item => { const groupKey = new Date(item.timestamp).toDateString(); if (!grouped[groupKey]) grouped[groupKey] = []; grouped[groupKey].push(item); });
                for (const groupKey in grouped) { const headerTpl = historyGroupTemplate.content.cloneNode(true); headerTpl.querySelector('.history-group-header').textContent = groupKey; fragment.appendChild(headerTpl); 
                    grouped[groupKey].forEach(item => { const itemTpl = historyItemTemplate.content.cloneNode(true); const li = itemTpl.querySelector('li'); li.dataset.url = item.url; li.title = `${item.title}\n${item.url}`; li.querySelector('.item-name').textContent = item.title; li.querySelector('.item-url').textContent = item.url; fragment.appendChild(itemTpl); }); }
            }
            historyListPopupEl.innerHTML = ''; historyListPopupEl.appendChild(fragment);
        }
        function pruneHistory() {
            const lifespanDays = Number(localStorage.getItem('vernHistoryLifespan') || 14);
            if (lifespanDays === 0) return;
            const cutoffDate = new Date(); cutoffDate.setDate(cutoffDate.getDate() - lifespanDays);
            saveHistory(getHistory().filter(item => new Date(item.timestamp) >= cutoffDate));
        }
        function loadBookmarks() { const bms = JSON.parse(localStorage.getItem('vernBookmarks') || '[]'); bookmarksListPopupEl.innerHTML = ''; bms.forEach(renderBookmarkItem); }
        function saveBookmarks(bms) { localStorage.setItem('vernBookmarks', JSON.stringify(bms)); }
        function renderBookmarkItem(bm) { const li = bookmarkItemTemplate.content.cloneNode(true).firstElementChild; li.dataset.url = bm.url; li.title = `${bm.name}\n${bm.url}`; li.querySelector('.item-name').textContent = bm.name; li.querySelector('.item-url').textContent = bm.url; li.querySelector('.item-remove-button').onclick = (e) => { e.stopPropagation(); removeBookmark(bm.url); }; bookmarksListPopupEl.appendChild(li); }
        function handleAddCurrentBookmark() { if (!currentUrl || currentUrl.startsWith('about:')) return alert("Cannot bookmark this page."); const name = newBookmarkNameInputPopupEl.value.trim() || currentTitle; let bms = JSON.parse(localStorage.getItem('vernBookmarks') || '[]'); if (bms.some(b => b.url === currentUrl)) return alert("This page is already bookmarked."); bms.push({ name, url: currentUrl }); saveBookmarks(bms); renderBookmarkItem({ name, url: currentUrl }); newBookmarkNameInputPopupEl.value = ''; }
        function removeBookmark(url) { let bms = JSON.parse(localStorage.getItem('vernBookmarks') || '[]'); saveBookmarks(bms.filter(b => b.url !== url)); loadBookmarks(); }
        
        // --- DATA & SETTINGS MANAGEMENT ---
        function clearAllData() {
            if (confirm("Are you sure you want to clear ALL browser data? This will delete all bookmarks, history, and settings and cannot be undone.")) {
                Object.keys(localStorage).filter(k => k.startsWith('vern')).forEach(k => localStorage.removeItem(k));
                alert("All browser data has been cleared."); window.location.reload();
            }
        }
        function applyAndSaveCustomCloak() {
            localStorage.setItem('vernCustomCloakTitle', customCloakTitleEl.value);
            localStorage.setItem('vernCustomCloakUrl', customCloakUrlEl.value);
            currentCloakPresetKey = 'custom'; cloakPresetSelectorEl.value = 'custom';
            localStorage.setItem('vernCloakPreset', 'custom'); applyBrowserCloak();
            alert('Custom cloak applied and saved!');
        }

        // --- UI & MENU TOGGLING ---
        function toggleCustomCloakView(show) { customCloakSettingsContainerEl.classList.toggle('visible', show); }
        function closeAllMenus(event) {
             if (bookmarkMenuEl.classList.contains('show') && !bookmarkMenuEl.contains(event?.target) && !bookmarkButtonEl.contains(event?.target)) bookmarkMenuEl.classList.remove('show');
             if (historyMenuEl.classList.contains('show') && !historyMenuEl.contains(event?.target) && !historyButtonEl.contains(event?.target)) historyMenuEl.classList.remove('show');
             if (settingsMenuEl.classList.contains('show') && !settingsMenuEl.contains(event?.target) && !settingsButtonEl.contains(event?.target)) settingsMenuEl.classList.remove('show');
        }
        function positionMenuUnderButton(menuEl, buttonEl) {
            const btnRect = buttonEl.getBoundingClientRect();
            const isBottomBar = document.body.classList.contains('theme-bottom-bar');
            if (isBottomBar) {
                menuEl.style.top = 'auto';
                menuEl.style.bottom = (window.innerHeight - btnRect.top + 5) + 'px';
            } else {
                menuEl.style.bottom = 'auto';
                menuEl.style.top = (btnRect.bottom + 5) + 'px';
            }
            menuEl.style.right = (document.documentElement.clientWidth - btnRect.right) + 'px';
            menuEl.style.left = 'auto';
        }
        function toggleMenu(menuEl, buttonEl) {
            const isShowing = menuEl.classList.contains('show');
            closeAllMenus();
            if (!isShowing) {
                menuEl.classList.add('show');
                positionMenuUnderButton(menuEl, buttonEl);
            }
        }
        function toggleBookmarkMenu() { toggleMenu(bookmarkMenuEl, bookmarkButtonEl); }
        function toggleHistoryMenu() { toggleMenu(historyMenuEl, historyButtonEl); if(historyMenuEl.classList.contains('show')) historySearchBarEl.focus(); }
        function toggleSettingsMenu() { toggleMenu(settingsMenuEl, settingsButtonEl); }
        
        // --- POPULATORS & THEMING ---
        function populateThemeSelector() {
            themeSelectorEl.innerHTML = '';
            const standardThemesGroup = document.createElement('optgroup'); standardThemesGroup.label = 'Standard Themes';
            const specialThemesGroup = document.createElement('optgroup'); specialThemesGroup.label = 'Special Themes';
            Object.keys(THEMES).forEach(key => {
                const theme = THEMES[key];
                const option = new Option(theme.name, key);
                if (theme.feature) { specialThemesGroup.appendChild(option); } 
                else { standardThemesGroup.appendChild(option); }
            });
            themeSelectorEl.appendChild(standardThemesGroup);
            themeSelectorEl.appendChild(specialThemesGroup);
        }
        function applyTheme(themeKey) {
            const r = document.documentElement;
            stopAllParticles();
            document.body.className = '';
            r.style.setProperty('--font-family-main', "'PrimaryFont', sans-serif");
            
            const theme = THEMES[themeKey] || THEMES.main;
            const colors = theme.colors;
            r.style.setProperty('--current-theme-bg', colors.bg); r.style.setProperty('--current-theme-text', colors.text);
            r.style.setProperty('--current-theme-accent', colors.accent); r.style.setProperty('--current-theme-neutral', colors.neutral);
            r.style.setProperty('--current-theme-button-text', colors.btnText);

            if (theme.feature) {
                document.body.classList.add(`theme-${theme.feature.toLowerCase()}`);
                if (theme.feature === 'retroTerminal') r.style.setProperty('--font-family-main', "'Courier New', Courier, monospace");
                else if (['particleFlow', 'oceanDeep', 'sakuraBlossom'].includes(theme.feature)) startParticleEffect(theme.feature);
            }
        }
        function populateCloakSelector() { Object.keys(cloakPresets).forEach(key => cloakPresetSelectorEl.add(new Option(cloakPresets[key].displayName, key))); }
        function populateSearchEngineSelector() { Object.keys(searchEngines).forEach(key => searchEngineSelectorEl.add(new Option(searchEngines[key].name, key))); }
        function applyBrowserCloak() {
            const appFaviconEl = document.getElementById('app-favicon');
            const selectedPreset = cloakPresets[currentCloakPresetKey];
            if (currentCloakPresetKey === 'custom') {
                const customTitle = localStorage.getItem('vernCustomCloakTitle') || 'Vern Max';
                const customFaviconUrlSource = localStorage.getItem('vernCustomCloakUrl') || 'logo.png';
                document.title = customTitle; appFaviconEl.href = getFaviconUrl(customFaviconUrlSource);
            } else if (selectedPreset && currentCloakPresetKey !== 'none') {
                document.title = selectedPreset.title; appFaviconEl.href = selectedPreset.faviconUrl;
            } else {
                document.title = currentTitle || 'Vern Max'; appFaviconEl.href = getFaviconUrl(currentUrl);
            }
        }
        function getFaviconUrl(targetUrl) {
            if (!targetUrl || targetUrl.startsWith('about:')) return 'logo.png';
            try { const url = new URL(targetUrl); return `https://icons.duckduckgo.com/ip3/${url.hostname}.ico`; } 
            catch (e) { return 'logo.png'; }
        }
        
        // --- EVENT HANDLERS & UTILITIES ---
        function handleBookmarkClick(e) { const li = e.target.closest('li[data-url]'); if (li) { navigateTo(li.dataset.url); closeAllMenus(); } }
        function handleHistoryClick(e) { const li = e.target.closest('li[data-url]'); if (li) { navigateTo(li.dataset.url); closeAllMenus(); } }
        function handleGlobalKeyDown(e) { if (e.target.tagName === 'INPUT' || e.target.isContentEditable) return; if (e.altKey && e.key === 'ArrowLeft') backButtonEl.click(); if (e.altKey && e.key === 'ArrowRight') forwardButtonEl.click(); if ((e.ctrlKey || e.metaKey) && e.key === 'r') { e.preventDefault(); refreshButtonEl.click(); } if ((e.ctrlKey || e.metaKey) && e.key === 'l') { e.preventDefault(); searchBarEl.select(); }}
        function toggleIframeFullscreen() { if (!document.fullscreenElement) contentIframeEl.requestFullscreen(); else document.exitFullscreen(); }
        function handleFullscreenChange() {
            const isFullscreen = !!document.fullscreenElement;
            document.body.classList.toggle('app-ui-hidden', isFullscreen);
            document.getElementById('fullscreen-icon-img').src = `../images/zoom-${isFullscreen ? 'out' : 'in'}-white.png`;
        }
    </script>
</body>
</html>
