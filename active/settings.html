<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>VERN MAX</title>
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="icon" type="image/x-icon" href="../images/favicon.png" id="app-favicon" />
    <style id="custom-styles">
        @import url('https://fonts.googleapis.com/css2?family=Bangers&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Crete+Round&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap');

        /* Core Theme Variables & Component Mappings */
        :root {
            --current-theme-bg: #23272A;
            --current-theme-text: #E0E1DD;
            --current-theme-accent: #7F5AF0;
            --current-theme-neutral: #2C2F33;
            --current-theme-button-text: #FFFFFF;
            --current-theme-shadow-rgb: 0, 0, 0;
            --current-theme-shadow-opacity-strong: 0.4;
            --current-theme-shadow-opacity-medium: 0.25;
            --current-theme-shadow-opacity-light: 0.15;
            --current-theme-focus-ring-color: var(--current-theme-accent);

            --bg-color: var(--current-theme-bg);
            --text-color: var(--current-theme-text);
            --iframe-bg: var(--current-theme-bg);
            --font-family-main: 'PrimaryFont', sans-serif;

            --toolbar-bg: var(--current-theme-neutral);
            --toolbar-shadow: 0 2px 5px rgba(var(--current-theme-shadow-rgb), var(--current-theme-shadow-opacity-medium));
            --toolbar-border-color: color-mix(in srgb, var(--current-theme-neutral) 70%, var(--current-theme-text));

            --button-bg: var(--current-theme-accent);
            --button-hover-bg: color-mix(in srgb, var(--current-theme-accent) 80%, var(--current-theme-text));
            --button-text-color: var(--current-theme-button-text);
            --button-outline-color: color-mix(in srgb, var(--current-theme-accent) 60%, transparent);

            --input-bg: color-mix(in srgb, var(--current-theme-neutral) 90%, var(--current-theme-bg));
            --input-focus-bg: var(--current-theme-bg);
            --input-focus-shadow: 0 0 0 2px color-mix(in srgb, var(--current-theme-focus-ring-color) 50%, transparent);

            --menu-bg: var(--input-bg);
            --menu-item-hover-bg: var(--button-hover-bg);
            --menu-text-color: var(--text-color);
            --menu-shadow: 0 4px 12px rgba(var(--current-theme-shadow-rgb), var(--current-theme-shadow-opacity-strong));
            --menu-border-color: var(--button-outline-color);
        }

        /* Base Styles */
        html, body {
            margin: 0; padding: 0; border: none; box-sizing: border-box;
            width: 100%; height: 100%; overflow: hidden;
            font-family: var(--font-family-main);
            background-color: var(--bg-color); color: var(--text-color);
            display: flex; flex-direction: column;
        }
        canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; display: none; pointer-events: none; }

        /* Toolbar */
        #toolbar {
            display: flex; align-items: center; padding: 8px 10px;
            background-color: var(--toolbar-bg); box-shadow: var(--toolbar-shadow);
            border-bottom: 1px solid var(--toolbar-border-color); z-index: 1000; position: relative;
        }
        .nav-button, .toolbar-button {
            width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
            margin-right: 8px; border-radius: 25%; background-color: var(--button-bg);
            cursor: pointer; color: var(--button-text-color); transition: background-color 0.2s, color 0.2s;
            box-shadow: 0 0 0 1px var(--button-outline-color); font-size: 20px;
            position: relative; flex-shrink: 0;
        }
        .nav-button:hover, .toolbar-button:hover { background-color: var(--button-hover-bg); }
        .nav-button .icon-img, .toolbar-button .icon-img {
            width: 20px; height: 20px; user-select: none; pointer-events: none;
        }
        #search-bar {
            flex: 1; height: 36px; border-radius: 8px; border: none; background-color: var(--input-bg);
            color: var(--text-color); padding: 0 15px; font-size: 14px;
            box-shadow: 0 0 0 1px var(--button-outline-color); font-family: var(--font-family-main);
            margin-right: 8px;
        }
        #search-bar:focus { outline: none; background-color: var(--input-focus-bg); box-shadow: var(--input-focus-shadow); }

        /* Main Content */
        #content-container { flex: 1; position: relative; background-color: var(--iframe-bg); overflow: hidden; }
        #content-iframe { width: 100%; height: 100%; border: none; display: block; }
        
        /* Animations & States */
        #refresh-button .icon-img.spinning { animation: spinRefreshIcon 0.7s linear infinite; }
        @keyframes spinRefreshIcon { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        body.app-ui-hidden #toolbar { display: none !important; }

        /* Homepage Styles */
        #homepage {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            text-align: center;
            background-color: var(--bg-color);
            padding: 20px;
            box-sizing: border-box;
        }

        #homepage-logo {
            max-width: 280px;
            height: auto;
            margin-bottom: 30px;
        }

        #homepage-search-container {
            position: relative;
            width: 100%;
            max-width: 584px;
            height: 38px;
            display: flex;
            align-items: center;
            border-radius: 8px;
            background-color: var(--input-bg);
            border: none;
            box-shadow: 0 0 0 1px var(--button-outline-color);
            transition: background-color 0.2s, box-shadow 0.2s;
        }

        #homepage-search-container:focus-within {
            background-color: var(--input-focus-bg);
            box-shadow: var(--input-focus-shadow);
        }
        
        #homepage-search-bar {
            flex: 1;
            height: 36px;
            border: none;
            background: transparent;
            color: var(--text-color);
            padding: 0 15px;
            font-size: 14px;
            box-sizing: border-box;
            outline: none;
            font-family: var(--font-family-main);
        }

        #homepage-search-icon {
            width: 18px;
            height: 18px;
            padding: 9px;
            border-radius: 50%;
            margin-right: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #homepage-search-icon:hover {
            background-color: rgba(var(--current-theme-shadow-rgb), 0.1);
        }

        #search-suggestions {
            display: none;
            position: absolute;
            top: calc(100% + 5px);
            left: 0;
            right: 0;
            background-color: var(--menu-bg);
            border: 1px solid var(--menu-border-color);
            border-radius: 12px;
            list-style: none;
            padding: 10px 0;
            margin: 0;
            text-align: left;
            z-index: 100;
            box-shadow: var(--menu-shadow);
        }
        #search-suggestions li { padding: 10px 20px; cursor: pointer; color: var(--menu-text-color); }
        #search-suggestions li:hover { background-color: var(--menu-item-hover-bg); color: var(--button-text-color); }
        .search-engine-explanation { font-size: 0.8em; color: var(--text-color); opacity: 0.7; margin-top: -8px; /* Adjust as needed to position it correctly */ margin-bottom: 10px; padding-left: 5px; }

    </style>
</head>
<body>
    <canvas id="canvas"></canvas>

    <div id="toolbar">
        <div class="nav-button" id="home-button" title="Home"><img src="../images/home-white.png" alt="Home" class="icon-img"></div>
        <div class="nav-button" id="refresh-button" title="Refresh"><img src="../images/refresh-white.png" alt="Refresh" class="icon-img"></div>
        <input type="text" id="search-bar" placeholder="Search or type a URL">
    </div>

    <div id="content-container">
        <iframe id="content-iframe" src="about:blank"></iframe>
        <div id="homepage">
            <img src="../images/vernmax-logo.png" alt="VERN MAX Logo" id="homepage-logo">
            <div id="homepage-search-container">
                <img src="../images/search-white.png" alt="Search" id="homepage-search-icon">
                <input type="text" id="homepage-search-bar" placeholder="Search or type a URL">
            </div>
            <ul id="search-suggestions"></ul>
            <p class="search-engine-explanation">Powered by DuckDuckGo</p>
        </div>
    </div>

    <script>
        // --- DOM ELEMENTS ---
        const homeButtonEl = document.getElementById('home-button');
        const refreshButtonEl = document.getElementById('refresh-button');
        const searchBarEl = document.getElementById('search-bar');
        const contentIframeEl = document.getElementById('content-iframe');
        const homepageEl = document.getElementById('homepage');
        const homepageSearchBarEl = document.getElementById('homepage-search-bar');
        const homepageSearchIconEl = document.getElementById('homepage-search-icon');
        const searchSuggestionsEl = document.getElementById('search-suggestions');
        const appFaviconEl = document.getElementById('app-favicon');

        // --- STATE ---
        let currentUrl = 'about:blank';
        let isHomepageVisible = true;

        // --- CORE NAVIGATION & DISPLAY ---
        function navigateTo(url, saveHistory = true) {
            let targetUrl = url;
            if (!targetUrl.startsWith('http://') && !targetUrl.startsWith('https://') && !targetUrl.startsWith('about:') && !targetUrl.startsWith('data:')) {
                if (targetUrl.includes('.')) {
                    targetUrl = 'https://' + targetUrl;
                } else {
                    targetUrl = `https://duckduckgo.com/?q=${encodeURIComponent(targetUrl)}`;
                }
            }
            contentIframeEl.src = targetUrl;
            searchBarEl.value = targetUrl;
            currentUrl = targetUrl;
            hideHomepage();
            updateFavicon(targetUrl);
        }

        function showHomepage() {
            homepageEl.style.display = 'flex';
            contentIframeEl.style.display = 'none';
            searchBarEl.value = ''; // Clear search bar when on homepage
            homepageSearchBarEl.value = '';
            isHomepageVisible = true;
            updateFavicon('about:blank');
        }

        function hideHomepage() {
            homepageEl.style.display = 'none';
            contentIframeEl.style.display = 'block';
            isHomepageVisible = false;
        }

        function refreshPage() {
            refreshButtonEl.querySelector('.icon-img').classList.add('spinning');
            contentIframeEl.contentWindow.location.reload();
            setTimeout(() => {
                refreshButtonEl.querySelector('.icon-img').classList.remove('spinning');
            }, 700); // Remove spinning class after 0.7 seconds
        }

        function updateFavicon(url) {
            if (url.startsWith('about:')) return '../images/favicon.png';
            try { const urlObj = new URL(url); appFaviconEl.href = `https://icons.duckduckgo.com/ip3/${urlObj.hostname}.ico`; }
            catch (e) { appFaviconEl.href = '../images/favicon.png'; }
        }

        // --- EVENT HANDLERS & UTILITIES ---
        function handleHomeClick() { showHomepage(); }
        function handleRefreshClick() { refreshPage(); }

        function handleSearchBarEnter(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                navigateTo(searchBarEl.value);
                searchBarEl.blur(); // Remove focus after search
                searchSuggestionsEl.style.display = 'none'; // Hide suggestions
            }
        }

        function handleHomepageSearchBarEnter(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                navigateTo(homepageSearchBarEl.value);
                homepageSearchBarEl.blur(); // Remove focus after search
                searchSuggestionsEl.style.display = 'none'; // Hide suggestions
            }
        }

        function handleHomepageSearchIconClick() {
            navigateTo(homepageSearchBarEl.value);
            searchSuggestionsEl.style.display = 'none'; // Hide suggestions
        }

        function fetchSuggestions(query) {
            if (query.length < 2) {
                searchSuggestionsEl.style.display = 'none';
                return;
            }
            fetch(`https://duckduckgo.com/ac/?q=${encodeURIComponent(query)}&type=json`)
                .then(response => response.json())
                .then(data => {
                    displaySuggestions(data);
                })
                .catch(error => console.error('Error fetching search suggestions:', error));
        }

        function displaySuggestions(suggestions) {
            searchSuggestionsEl.innerHTML = '';
            if (suggestions.length === 0) {
                searchSuggestionsEl.style.display = 'none';
                return;
            }
            suggestions.forEach(s => {
                const li = document.createElement('li');
                li.textContent = s.phrase;
                li.addEventListener('click', () => {
                    if (isHomepageVisible) {
                        homepageSearchBarEl.value = s.phrase;
                        navigateTo(s.phrase);
                    } else {
                        searchBarEl.value = s.phrase;
                        navigateTo(s.phrase);
                    }
                    searchSuggestionsEl.style.display = 'none';
                });
                searchSuggestionsEl.appendChild(li);
            });
            searchSuggestionsEl.style.display = 'block';
        }

        // Close suggestions if clicked outside
        document.addEventListener('click', (e) => {
            if (!searchSuggestionsEl.contains(e.target) && e.target !== searchBarEl && e.target !== homepageSearchBarEl) {
                searchSuggestionsEl.style.display = 'none';
            }
        });

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            homeButtonEl.addEventListener('click', handleHomeClick);
            refreshButtonEl.addEventListener('click', handleRefreshClick);

            searchBarEl.addEventListener('keydown', handleSearchBarEnter);
            searchBarEl.addEventListener('input', () => fetchSuggestions(searchBarEl.value));

            homepageSearchBarEl.addEventListener('keydown', handleHomepageSearchBarEnter);
            homepageSearchBarEl.addEventListener('input', () => fetchSuggestions(homepageSearchBarEl.value));
            homepageSearchIconEl.addEventListener('click', handleHomepageSearchIconClick);

            showHomepage(); // Start on the homepage
        });

        // Update search bar value when iframe navigates (e.g., via links)
        contentIframeEl.addEventListener('load', () => {
            try {
                // Check for about:blank first to avoid security errors trying to access contentWindow.location
                if (contentIframeEl.contentWindow.location.href !== 'about:blank') {
                    searchBarEl.value = contentIframeEl.contentWindow.location.href;
                    currentUrl = contentIframeEl.contentWindow.location.href;
                    updateFavicon(currentUrl);
                }
            } catch (e) {
                // Handle cross-origin issues
                searchBarEl.value = contentIframeEl.src;
                currentUrl = contentIframeEl.src;
                updateFavicon(currentUrl);
            }
        });

    </script>
</body>
</html>
